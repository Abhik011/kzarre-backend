#!/bin/bash
set -e

APP_DIR="/home/ec2-user/kzarre-backend"
BLUE_PORT=5501
GREEN_PORT=5502

BLUE_NAME="kzarre-backend-blue"
GREEN_NAME="kzarre-backend-green"

echo "ğŸ”„ Pulling latest backend code..."
cd $APP_DIR
git pull

echo "ğŸ“¦ Installing dependencies..."
npm install --production

# Detect which slot is free
if pm2 describe $BLUE_NAME > /dev/null 2>&1; then
    TARGET=$GREEN_NAME
    PORT=$GREEN_PORT
else
    TARGET=$BLUE_NAME
    PORT=$BLUE_PORT
fi

echo "ğŸš€ Starting backend ($TARGET) on port $PORT..."
pm2 start server.js --name $TARGET -- --port=$PORT || pm2 restart $TARGET -- --port=$PORT

echo "â³ Waiting for app to boot..."
sleep 5

echo "ğŸ©º Running health check..."
if curl -fs http://127.0.0.1:$PORT/ > /dev/null; then
    echo "âœ… Backend healthy. Switching traffic..."
    bash /home/ec2-user/switch-blue-green.sh backend $PORT
else
    echo "âŒ Backend failed health check! Aborting."
    exit 1
fi

echo "ğŸ’¾ Saving PM2 state..."
pm2 save
